/// Represents individual coding test instances assigned to applications.
/// Tracks type (internal or external), scheduling, delivery channel, and
/// test meta. Linked to application, applicant, and HR/recruiter. Required
/// for audit trail, API callback correlation, and re-delivery logic.
///
/// @namespace CodingTests
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model ats_recruitment_coding_tests {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Belonged application's {@link ats_recruitment_applications.id}
  ats_recruitment_application_id String
  
  /// Belonged applicant's {@link ats_recruitment_applicants.id}
  ats_recruitment_applicant_id String
  
  /// Belonged HR recruiter who assigned/triggered this test. {@link
  /// ats_recruitment_hrrecruiters.id}
  ats_recruitment_hrrecruiter_id String
  
  /// Provider type: 'internal' (platform written), or 3rd party text such as
  /// 'programmers', 'codesignal'.
  test_provider String
  
  /// ID returned by external provider system, if external. Required for
  /// callback. Use null if in-house.
  test_external_id String?
  
  /// Test access URL (if generated by external provider or for applicant's
  /// direct access).
  test_url String?
  
  /// Datetime when test is scheduled (set by HR/recruiter or system).
  scheduled_at DateTime
  
  /// Datetime when invitation/test was actually delivered to applicant.
  delivered_at DateTime?
  
  /// Current delivery/test state. Example: 'scheduled', 'delivered',
  /// 'in_progress', 'completed', 'failed', 'cancelled'.
  status String
  
  /// Last time applicant is allowed to take test (nullable for open-ended or
  /// instant tests).
  expiration_at DateTime?
  
  /// Timestamp when API callback received from external system (null if not
  /// applicable).
  callback_received_at DateTime?
  
  /// Datetime test is definitively closed for submission. Used for
  /// audit/tracking.
  closed_at DateTime?
  
  /// Canonical creation timestamp.
  created_at DateTime
  
  /// Canonical update timestamp.
  updated_at DateTime
  
  /// Soft-delete. Set on logical delete for audit reasons.
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  application ats_recruitment_applications @relation(fields: [ats_recruitment_application_id], references: [id], onDelete: Cascade)
  applicant ats_recruitment_applicants @relation(fields: [ats_recruitment_applicant_id], references: [id], onDelete: Cascade)
  hrRecruiter ats_recruitment_hrrecruiters @relation(fields: [ats_recruitment_hrrecruiter_id], references: [id], onDelete: Cascade)
  
  ats_recruitment_coding_test_submissions ats_recruitment_coding_test_submissions[]
  ats_recruitment_coding_test_results ats_recruitment_coding_test_results[]
  ats_recruitment_coding_test_external_logs ats_recruitment_coding_test_external_logs[]
  
  @@index([ats_recruitment_hrrecruiter_id], map: "ats_recruitment_coding_tests_ats_recruitment_hrrecruit_72033ec4")
  
  @@unique([test_external_id])
  @@index([ats_recruitment_application_id, scheduled_at], map: "ats_recruitment_coding_tests_ats_recruitment_applicati_bb7ad994")
  @@index([ats_recruitment_applicant_id])
  @@index([status])
}

/// Tracks each coding test solution attempt by an applicant. Used for
/// tracking attempts, answers, answer files, log/audit, and
/// late/invalid/timeout cases. Ties to coding test, applicant, and
/// application entity.
///
/// @namespace CodingTests
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model ats_recruitment_coding_test_submissions {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Referenced coding test's {@link ats_recruitment_coding_tests.id}
  ats_recruitment_coding_test_id String
  
  /// Applicant's {@link ats_recruitment_applicants.id} (in case of delegated
  /// submissions, still stores actual answerer)
  ats_recruitment_applicant_id String
  
  /// Parent application's {@link ats_recruitment_applications.id} (redundant
  /// but supports analytics for audit reporting)
  ats_recruitment_application_id String
  
  /// Timestamp when applicant submitted test answer.
  submitted_at DateTime
  
  /// URL (object storage, presigned download) for answer upload, if applicable.
  answer_file_url String?
  
  /// Direct answer text (if code is written inline).
  answer_text String?
  
  /// Current submission validation state: e.g., 'valid', 'invalid', 'timeout',
  /// 'canceled', 'pending'.
  status String
  
  /// Timestamp if this submission was posted via external API/callback, n/a
  /// for direct platform.
  received_external_at DateTime?
  
  /// Status for reviewer process: e.g. 'pending', 'needs_review', 'reviewed',
  /// 'flagged'.
  review_status String
  
  /// Datetime manual review completed by tech reviewer, null if still waiting.
  reviewed_at DateTime?
  
  /// Manual review summary (tech reviewer). Null if not yet reviewed or review
  /// was only automatic.
  review_comment_summary String?
  
  /// Canonical creation timestamp.
  created_at DateTime
  
  /// Canonical update timestamp.
  updated_at DateTime
  
  /// Soft-delete. Set for retention/audit compliance.
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  codingTest ats_recruitment_coding_tests @relation(fields: [ats_recruitment_coding_test_id], references: [id], onDelete: Cascade)
  applicant ats_recruitment_applicants @relation(fields: [ats_recruitment_applicant_id], references: [id], onDelete: Cascade)
  application ats_recruitment_applications @relation(fields: [ats_recruitment_application_id], references: [id], onDelete: Cascade)
  
  ats_recruitment_coding_test_results ats_recruitment_coding_test_results[]
  ats_recruitment_coding_test_review_comments ats_recruitment_coding_test_review_comments[]
  
  @@index([ats_recruitment_applicant_id], map: "ats_recruitment_coding_test_submissions_ats_recruitmen_b597d9a0")
  
  @@unique([ats_recruitment_coding_test_id, ats_recruitment_applicant_id], map: "ats_recruitment_coding_test_submissions_ats_recruitmen_2496bdf5")
  @@index([ats_recruitment_coding_test_id, submitted_at], map: "ats_recruitment_coding_test_submissions_ats_recruitmen_6246b248")
  @@index([ats_recruitment_application_id], map: "ats_recruitment_coding_test_submissions_ats_recruitmen_36a3c5a3")
}

/// Snapshot of automatic or reviewer-evaluated result for a coding test
/// submission. Contains normalized scores, ranking, error traces, and
/// abnormal completion audit (e.g., plagiarism or timeout). Not
/// overwrittenâ€”even on rerun/manual override; instead, new rows are
/// persisted.
///
/// @namespace CodingTests
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model ats_recruitment_coding_test_results {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Belonged submission's {@link ats_recruitment_coding_test_submissions.id}
  ats_recruitment_coding_test_submission_id String
  
  /// Parent coding test's {@link ats_recruitment_coding_tests.id}. Used to
  /// facilitate performance reporting/audit.
  ats_recruitment_coding_test_id String
  
  /// How result was computed; e.g. 'auto', 'manual', 'external', 'rerun',
  /// 'admin_override'.
  evaluation_method String
  
  /// Result score (0 ~ typically 100, but see provider doc).
  score Float
  
  /// Maximum score available for normalization (not null, needed for context).
  maximum_score Float
  
  /// True if submission is flagged as abnormal/plagiarized, e.g., by AI or
  /// reviewer.
  plagiarism_flag Boolean
  
  /// Applicant's percentile ranking for this test (0~100, where 100=top).
  ranking_percentile Float
  
  /// Free-form JSON string from automatic evaluation/report. May include
  /// testcases run, error messages, runtime stats, etc.
  result_json String?
  
  /// Datetime when this specific result record was finalized; for
  /// snapshot/audit.
  finalized_at DateTime
  
  /// Canonical creation timestamp.
  created_at DateTime
  
  /// Canonical update timestamp.
  updated_at DateTime
  
  /// Soft-delete (retain in audit).
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  submission ats_recruitment_coding_test_submissions @relation(fields: [ats_recruitment_coding_test_submission_id], references: [id], onDelete: Cascade)
  codingTest ats_recruitment_coding_tests @relation(fields: [ats_recruitment_coding_test_id], references: [id], onDelete: Cascade)
  
  @@unique([ats_recruitment_coding_test_submission_id, finalized_at], map: "ats_recruitment_coding_test_results_ats_recruitment_co_da0734db")
  @@index([ats_recruitment_coding_test_id, score], map: "ats_recruitment_coding_test_results_ats_recruitment_co_3094ef36")
  @@index([plagiarism_flag])
}

/// Holds detailed reviewer and automated feedback, supporting independent
/// moderation workflows and review audits per submission. Allows multiple
/// comments per submission: each row is immutable (snapshot pattern).
/// Reviewers are identified by FK, comment history is preserved even if
/// users leave/disconnect.
///
/// @namespace CodingTests
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model ats_recruitment_coding_test_review_comments {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Associated submission's {@link
  /// ats_recruitment_coding_test_submissions.id}.
  ats_recruitment_coding_test_submission_id String
  
  /// Reviewer user reference {@link ats_recruitment_techreviewers.id}.
  ats_recruitment_techreviewer_id String
  
  /// Reviewer or system-generated comment, markdown and text. Not null.
  comment_text String
  
  /// Source/type: 'manual', 'auto', 'system', 'plagiarism_flag', etc.
  comment_type String
  
  /// Reviewer started typing/working at this time (audit).
  started_at DateTime
  
  /// Datetime comment was finalized (immutable).
  commented_at DateTime
  
  /// Creation timestamp (redundant for audit, shown for direct DB access).
  created_at DateTime
  
  /// Canonical update timestamp.
  updated_at DateTime
  
  /// Soft-delete (manual or policy-based).
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  submission ats_recruitment_coding_test_submissions @relation(fields: [ats_recruitment_coding_test_submission_id], references: [id], onDelete: Cascade)
  techReviewer ats_recruitment_techreviewers @relation(fields: [ats_recruitment_techreviewer_id], references: [id], onDelete: Cascade)
  
  @@unique([ats_recruitment_coding_test_submission_id, ats_recruitment_techreviewer_id, commented_at], map: "ats_recruitment_coding_test_review_comments_ats_recrui_f8f555f8")
  @@index([ats_recruitment_techreviewer_id, commented_at], map: "ats_recruitment_coding_test_review_comments_ats_recrui_f669d3a7")
}

/// Tracks all interactions, callbacks, requests, and error responses with
/// external coding test providers per test or per submission. Used for
/// troubleshooting, replay, compensation, and dispute handling. Not directly
/// user-facing but required for secure audit.
///
/// @namespace CodingTests
/// @author AutoBE - https://github.com/wrtnlabs/autobe
model ats_recruitment_coding_test_external_logs {
  //----
  // COLUMNS
  //----
  /// Primary Key.
  id String @id
  
  /// Related coding test's {@link ats_recruitment_coding_tests.id}
  ats_recruitment_coding_test_id String
  
  /// Type of event (api_request, api_response, api_callback, error, etc.)
  event_type String
  
  /// Free-form JSON content with error or payload for the event.
  event_payload String
  
  /// External ref id, if any (provider id, callback token, submission id, etc)
  external_id String?
  
  /// Provider or ATS-internal message/description.
  message String?
  
  /// Exact time of event/interaction.
  occurred_at DateTime
  
  /// Canonical creation timestamp.
  created_at DateTime
  
  /// Canonical update timestamp.
  updated_at DateTime
  
  /// Soft-delete/retention.
  deleted_at DateTime?
  
  //----
  // RELATIONS
  //----
  codingTest ats_recruitment_coding_tests @relation(fields: [ats_recruitment_coding_test_id], references: [id], onDelete: Cascade)
  
  @@index([ats_recruitment_coding_test_id, event_type, occurred_at], map: "ats_recruitment_coding_test_external_logs_ats_recruitm_c8a66126")
}