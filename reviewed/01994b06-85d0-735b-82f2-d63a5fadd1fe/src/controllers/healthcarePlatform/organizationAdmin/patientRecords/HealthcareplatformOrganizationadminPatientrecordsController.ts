import { Controller } from "@nestjs/common";
import { TypedRoute, TypedBody, TypedParam } from "@nestia/core";
import typia, { tags } from "typia";
import { posthealthcarePlatformOrganizationAdminPatientRecords } from "../../../../providers/posthealthcarePlatformOrganizationAdminPatientRecords";
import { OrganizationadminAuth } from "../../../../decorators/OrganizationadminAuth";
import { OrganizationadminPayload } from "../../../../decorators/payload/OrganizationadminPayload";
import { patchhealthcarePlatformOrganizationAdminPatientRecords } from "../../../../providers/patchhealthcarePlatformOrganizationAdminPatientRecords";
import { gethealthcarePlatformOrganizationAdminPatientRecordsPatientRecordId } from "../../../../providers/gethealthcarePlatformOrganizationAdminPatientRecordsPatientRecordId";
import { puthealthcarePlatformOrganizationAdminPatientRecordsPatientRecordId } from "../../../../providers/puthealthcarePlatformOrganizationAdminPatientRecordsPatientRecordId";

import { IHealthcarePlatformPatientRecord } from "../../../../api/structures/IHealthcarePlatformPatientRecord";
import { IPageIHealthcarePlatformPatientRecord } from "../../../../api/structures/IPageIHealthcarePlatformPatientRecord";

@Controller("/healthcarePlatform/organizationAdmin/patientRecords")
export class HealthcareplatformOrganizationadminPatientrecordsController {
  /**
   * Create a new patient record in healthcare_platform_patient_records table.
   *
   * This endpoint allows for creating a new patient record within a specified
   * organization (and optionally mapped department), as defined by the
   * 'healthcare_platform_patient_records' table. Required fields include
   * patient user reference, full legal name, date of birth, demographic data in
   * JSON format if available, and business status. Optional fields such as
   * external patient number, gender, and department ID support advanced mapping
   * or integration needs. Timestamps for creation and updates are managed by
   * the system.
   *
   * Roles allowed to use this operation are tightly regulated: patient creation
   * can be performed by the organization's admin staff, clinical staff with
   * patient onboarding permissions, or by authorized receptionists during
   * intake. The business logic validates all required fields, checks for
   * duplicate assignments by patient_user_id, and applies organizational data
   * isolation rules. A successfully created record is returned for further use
   * in EHR flows, appointment booking, or regulatory workflows.
   *
   * If records are created for patients already active, appropriate errors or
   * contextual data (e.g., merging, archival logic) are triggered to align with
   * platform business rules. All creation actions are audit logged for
   * regulatory compliance and incident investigation.
   *
   * @param connection
   * @param body Data required to create a new patient record, including user
   *   reference, demographics, and business metadata.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Post()
  public async create(
    @OrganizationadminAuth()
    organizationAdmin: OrganizationadminPayload,
    @TypedBody()
    body: IHealthcarePlatformPatientRecord.ICreate,
  ): Promise<IHealthcarePlatformPatientRecord> {
    try {
      return await posthealthcarePlatformOrganizationAdminPatientRecords({
        organizationAdmin,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Search and paginate patient records with advanced filters
   * (healthcare_platform_patient_records).
   *
   * This operation retrieves a paginated, filtered list of patient records
   * housed within the healthcarePlatform system. It is designed for use by
   * authorized roles such as clinicians, administrative staff, and compliance
   * officers who require efficient access to longitudinal patient data across
   * organizational and departmental boundaries.
   *
   * The endpoint supports advanced search criteria, including but not limited
   * to partial name matches, date-of-birth ranges, demographic fields (handled
   * as JSON), status queries (active, inactive, deceased, transferred), and
   * optional filtering by department or organization. Sorting and pagination
   * parameters are implemented to support scalable, real-time data entry and
   * clinical review workflows.
   *
   * All search requests are logged with user and organization context for
   * compliance and auditability, ensuring that access to PHI aligns with
   * organizational policies. Privacy flags and consent controls are enforced,
   * and unauthorized users are denied access with appropriate error messaging.
   * Any inclusion of soft-deleted or archived records requires explicit
   * compliance override, and these cases are fully auditable.
   *
   * Related operations include detailed patient record retrieval (GET
   * /patientRecords/{id}), patient creation, and clinical encounter listing.
   * Error handling includes detailed feedback on failed queries, invalid
   * filters, or permission denials, following the organization's regulatory
   * requirements.
   *
   * @param connection
   * @param body Search criteria, filter, and pagination controls for advanced
   *   patient record queries.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Patch()
  public async index(
    @OrganizationadminAuth()
    organizationAdmin: OrganizationadminPayload,
    @TypedBody()
    body: IHealthcarePlatformPatientRecord.IRequest,
  ): Promise<IPageIHealthcarePlatformPatientRecord.ISummary> {
    try {
      return await patchhealthcarePlatformOrganizationAdminPatientRecords({
        organizationAdmin,
        body,
      });
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Retrieve a specific patient record by ID from
   * healthcare_platform_patient_records database table.
   *
   * This endpoint allows retrieval of a detailed patient record profile by
   * patientRecordId, as defined in the 'healthcare_platform_patient_records'
   * table. The operation returns all main columns: organization and department
   * assignment, patient user reference, external patient number if set, legal
   * full name, date of birth, gender, record status, extensible demographics
   * JSON, timestamps for creation and update, and the current soft delete
   * status.
   *
   * Access to this operation must be tightly controlled and audited due to the
   * presence of protected health information (PHI). Only authenticated and
   * authorized roles, such as clinical staff (doctor, nurse), department heads,
   * and admins, can invoke this endpoint with all access logged for HIPAA
   * compliance.
   *
   * Business logic includes: 1) Ensuring that only users within the same
   * organization or with explicit delegated rights can access the record; 2)
   * Checking the 'deleted_at' soft delete flagâ€”records with this set are
   * excluded unless under audit special circumstances; 3) Supporting regulatory
   * workflows, audit requirements, and patient self-access consent rules as
   * described in business specifications. Errors are handled by returning not
   * found for non-existent or ineligible records, and special messaging when
   * access is denied due to consent or assignment boundaries.
   *
   * @param connection
   * @param patientRecordId Unique identifier of the patient record to retrieve.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Get(":patientRecordId")
  public async at(
    @OrganizationadminAuth()
    organizationAdmin: OrganizationadminPayload,
    @TypedParam("patientRecordId")
    patientRecordId: string & tags.Format<"uuid">,
  ): Promise<IHealthcarePlatformPatientRecord> {
    try {
      return await gethealthcarePlatformOrganizationAdminPatientRecordsPatientRecordId(
        {
          organizationAdmin,
          patientRecordId,
        },
      );
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Update an existing patient record identified by patientRecordId in the main
   * patient records schema.
   *
   * This endpoint enables authorized users to update the properties of a given
   * patient record entry identified by patientRecordId. Allowed modification
   * fields, as defined in the patient records Prisma schema, include legal
   * name, demographics JSON, department, gender, status, and other
   * non-immutable fields (excluding organization and primary user references,
   * which are not generally modifiable post-creation).
   *
   * Update attempts are tightly controlled: only clinical staff with proper
   * permissions, organization admins, or department heads may update records.
   * The operation validates input, checks for conflicting soft delete status
   * (deleted_at), and ensures consistency with regulatory requirements. All
   * modifications are recorded in the audit trail, and significant changes may
   * trigger versioning and amendment flows for compliance, depending on
   * organizational policy and legal requirements.
   *
   * Business logic must also check for legal holds, privacy flags, and explicit
   * patient consent requirements before applying updates. Rejected changes due
   * to regulatory or consent restrictions are handled with descriptive errors,
   * and client logic may prompt for required approvals.
   *
   * @param connection
   * @param patientRecordId Unique identifier for the patient record to update.
   * @param body Fields required to update a patient record, respecting business
   *   validation rules and data isolation.
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Put(":patientRecordId")
  public async update(
    @OrganizationadminAuth()
    organizationAdmin: OrganizationadminPayload,
    @TypedParam("patientRecordId")
    patientRecordId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IHealthcarePlatformPatientRecord.IUpdate,
  ): Promise<IHealthcarePlatformPatientRecord> {
    try {
      return await puthealthcarePlatformOrganizationAdminPatientRecordsPatientRecordId(
        {
          organizationAdmin,
          patientRecordId,
          body,
        },
      );
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
