import { Controller } from "@nestjs/common";
import { TypedRoute, TypedParam, TypedBody } from "@nestia/core";
import typia, { tags } from "typia";
import { patchhealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendments } from "../../../../../providers/patchhealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendments";
import { SystemadminAuth } from "../../../../../decorators/SystemadminAuth";
import { SystemadminPayload } from "../../../../../decorators/payload/SystemadminPayload";
import { gethealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId } from "../../../../../providers/gethealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId";
import { puthealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId } from "../../../../../providers/puthealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId";
import { deletehealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId } from "../../../../../providers/deletehealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId";

import { IPageIHealthcarePlatformRecordAmendment } from "../../../../../api/structures/IPageIHealthcarePlatformRecordAmendment";
import { IHealthcarePlatformRecordAmendment } from "../../../../../api/structures/IHealthcarePlatformRecordAmendment";

@Controller(
  "/healthcarePlatform/systemAdmin/patientRecords/:patientRecordId/recordAmendments",
)
export class HealthcareplatformSystemadminPatientrecordsRecordamendmentsController {
  /**
   * Retrieve a paginated index of record amendments for a specific patient
   * record.
   *
   * Retrieve a filtered and paginated index of record amendments for a given
   * patient record. This endpoint allows compliance staff, department heads,
   * and clinical roles to audit the lifecycle of all changes, corrections, or
   * regulatory amendments to the patient's medical record.
   *
   * Security considerations require that users have appropriate RBAC permission
   * to view amendment history for the patient. Access is restricted by role and
   * organizational boundaries. All results are filtered to the requesting
   * user's access rights.
   *
   * The response structure includes paginated amendment data with amendment
   * metadata (type, status, submitter, rationale, old/new values) and can be
   * expanded by role permissions. Amendments under review, pending approval, or
   * rejected will contain their current status for workflow handling. Error
   * handling distinguishes between not found, not authorized, or query
   * constraint violations. If the patient record or amendments are soft
   * deleted, only appropriate admins will see historic data where compliant.
   *
   * This operation aligns with business rules requiring longitudinal
   * traceability and versioned record keeping for all PHI amendments,
   * supporting regulatory audits and clinical workflows.
   *
   * @param connection
   * @param patientRecordId Unique identifier of the patient record to query
   *   amendments for
   * @param body Search, filtering, and pagination criteria for record
   *   amendments linked to the patient record
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Patch()
  public async index(
    @SystemadminAuth()
    systemAdmin: SystemadminPayload,
    @TypedParam("patientRecordId")
    patientRecordId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IHealthcarePlatformRecordAmendment.IRequest,
  ): Promise<IPageIHealthcarePlatformRecordAmendment> {
    try {
      return await patchhealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendments(
        {
          systemAdmin,
          patientRecordId,
          body,
        },
      );
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Get full details of a specific record amendment on a patient record.
   *
   * Retrieve full details of a specific record amendment for a patient record.
   * This operation provides clinical, audit, and workflow information required
   * for individual review and regulatory traceability. It exposes amendment
   * metadata (type, rationale, submitter, reviewer, old and new value
   * snapshots, approval status, timestamps, and related encounter), to
   * authorized requesters based on RBAC as configured for audit trail
   * visibility.
   *
   * Access is limited by role, organization, and department scope to ensure
   * privacy and compliance, with error responses if the amendment is not found,
   * the record ID does not match the amendment's patient association, or if the
   * user's permissions are insufficient. If the amendment is in a pending or
   * restricted status, additional review markers will be shown depending on
   * reviewer role.
   *
   * This operation directly supports business rules for amendment audit trail
   * and workflow compliance, empowering end-to-end regulatory review, and is
   * referenced in record update and compliance review flows.
   *
   * @param connection
   * @param patientRecordId Unique identifier for the patient record
   * @param recordAmendmentId Unique identifier for the specific record
   *   amendment to retrieve
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Get(":recordAmendmentId")
  public async at(
    @SystemadminAuth()
    systemAdmin: SystemadminPayload,
    @TypedParam("patientRecordId")
    patientRecordId: string & tags.Format<"uuid">,
    @TypedParam("recordAmendmentId")
    recordAmendmentId: string & tags.Format<"uuid">,
  ): Promise<IHealthcarePlatformRecordAmendment> {
    try {
      return await gethealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId(
        {
          systemAdmin,
          patientRecordId,
          recordAmendmentId,
        },
      );
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Update an existing record amendment entry for a patient record.
   *
   * Update an existing record amendment for a patient record. Used by reviewers
   * (department heads, compliance staff) to approve, reject, or modify
   * rationale, value, or workflow status of a record amendment. Also supports
   * modification of amendment content where business rules allow, e.g.,
   * correction of fields, rationale updates, or reviewer assignment.
   *
   * Authorization is strictly enforced by user role and organizational/dept
   * assignment; only permitted roles may update amendment status or edit
   * content after initial creation. Approval workflows are triggered if the
   * amendment requires further review or additional compliance sign-off.
   * Attempts to update amendments for soft-deleted patient records will be
   * checked for regulatory compliance.
   *
   * Responses confirm updated entity details, workflow status, and audit
   * information. Business rules will prevent modification if amendment is
   * finalized, if the requester is not authorized, or if the update violates
   * compliance logic. Error handling clearly distinguishes between
   * authorization, business rule, and not found errors.
   *
   * @param connection
   * @param patientRecordId Identifier of the linked patient record
   * @param recordAmendmentId Unique identifier of the amendment entry to update
   * @param body Updated amendment data, including rationale, new/old value,
   *   approval, or reviewer info, as permitted by business rules
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Put(":recordAmendmentId")
  public async update(
    @SystemadminAuth()
    systemAdmin: SystemadminPayload,
    @TypedParam("patientRecordId")
    patientRecordId: string & tags.Format<"uuid">,
    @TypedParam("recordAmendmentId")
    recordAmendmentId: string & tags.Format<"uuid">,
    @TypedBody()
    body: IHealthcarePlatformRecordAmendment.IUpdate,
  ): Promise<IHealthcarePlatformRecordAmendment> {
    try {
      return await puthealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId(
        {
          systemAdmin,
          patientRecordId,
          recordAmendmentId,
          body,
        },
      );
    } catch (error) {
      console.log(error);
      throw error;
    }
  }

  /**
   * Permanently delete a specific record amendment from a patient's medical
   * record (healthcare_platform_record_amendments table).
   *
   * This endpoint provides deletion capability for amendment records tied to an
   * immutable patient clinical record. It requires both patientRecordId and
   * recordAmendmentId as path parameters. Only users with sufficient admin or
   * compliance privileges are allowed to perform this action, as removing
   * amendment history impacts longitudinal audit trails and regulatory
   * compliance.
   *
   * The operation accesses the healthcare_platform_record_amendments table,
   * ensuring referential integrity to the associated patient and encounter. All
   * attempts and results of this operation should be logged in compliance with
   * legal retention policies. An attempt to delete a non-existent or previously
   * deleted recordAmendmentId returns a not-found error.
   *
   * If a business or legal hold exists on the parent patient record, or the
   * amendment is required for ongoing audit, the provider implementation must
   * reject the erase and return a clear error to the client. This endpoint is
   * critical for rare, justified removal scenarios such as administrative error
   * and should integrate with broader audit logging workflows.
   *
   * @param connection
   * @param patientRecordId Unique identifier of the patient record associated
   *   with the amendment (UUID).
   * @param recordAmendmentId Unique identifier of the amendment to be deleted
   *   (UUID).
   * @nestia Generated by Nestia - https://github.com/samchon/nestia
   */
  @TypedRoute.Delete(":recordAmendmentId")
  public async erase(
    @SystemadminAuth()
    systemAdmin: SystemadminPayload,
    @TypedParam("patientRecordId")
    patientRecordId: string & tags.Format<"uuid">,
    @TypedParam("recordAmendmentId")
    recordAmendmentId: string & tags.Format<"uuid">,
  ): Promise<void> {
    try {
      return await deletehealthcarePlatformSystemAdminPatientRecordsPatientRecordIdRecordAmendmentsRecordAmendmentId(
        {
          systemAdmin,
          patientRecordId,
          recordAmendmentId,
        },
      );
    } catch (error) {
      console.log(error);
      throw error;
    }
  }
}
